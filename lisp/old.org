
;;; init-rust.el --- Rust development setup with lsp-bridge and rustic
;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; Performance optimizations

;; (setq gc-cons-threshold (* 100 1024 1024)) ; 100MB GC threshold
;; (setq read-process-output-max (* 1024 1024)) ; 1MB process output buffer
;; (setq lsp-file-watch-threshold 3000) ; Limit file watching
;; (unless (functionp 'json-serialize)
;;   (error "Emacs must be compiled with --with-json"))

;; (setq lsp-headerline-breadcrumb-mode -1)

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Rustic: Enhanced rust-mode with additional features

;; (use-package rustic
;;   :ensure t
;;   :bind (:map rustic-mode-map
;;               ("M-j" . lsp-bridge-diagnostic-jump-next)
;;               ("M-?" . lsp-bridge-find-references)
;;               ("C-c C-c l" . flycheck-list-errors)
;;               ("C-c C-c a" . lsp-bridge-code-action)
;;               ("C-c C-c r" . lsp-bridge-rename)
;;               ("C-c C-c q" . lsp-bridge-restart-process)
;;               ("C-c C-c Q" . kill-process)
;;               ("C-c C-c s" . lsp-bridge-server-status)
;;               ("C-c C-c e" . lsp-bridge-expand-macro)
;;               ("C-c C-c d" . dap-hydra)
;;               ("C-c C-c h" . lsp-bridge-popup-documentation))
;;   :hook (rustic-mode . rk/rustic-mode-hook)
;;   :config
;;   (setq lsp-bridge-enable-hover-diagnostic nil)
;;   (setq lsp-bridge-diagnostic-fetch-idle 0.6))

;; (defun rk/rustic-mode-hook ()
;;   "Custom hook for rustic-mode."
;;   (when buffer-file-name
;;     (setq-local buffer-save-without-query t))
;;   (add-hook 'before-save-hook 'lsp-bridge-format-buffer nil t)
;;   (corfu-mode 1))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; LSP-Bridge: Fast LSP client for rust-analyzer

;; (use-package lsp-bridge
;;   :straight '(lsp-bridge :type git :host github :repo "manateelazycat/lsp-bridge"
;;                         :files (:defaults "*.el" "*.py" "acm" "core" "langserver" "multiserver" "resources")
;;                         :build (:not compile))
;;   :hook ((rustic-mode . lsp-bridge-mode)
;;          (rustic-mode . yas-minor-mode))
;;   :init
;;   ;; Disable conflicting completion frameworks
;;   (when (fboundp 'global-company-mode)
;;     (global-company-mode -1))
;;   :config
;;   ;; Disable breadcrumb (headerline path like > apps > spider-rs > src > main.rs)
;;   (setq lsp-bridge-header-line-breadcrumb-mode nil)
;;   ;; Rust-analyzer configuration
;;   (setq lsp-bridge-user-langserver-dir "~/.emacs.d/lsp-bridge-langserver")
;;   (unless (file-directory-p lsp-bridge-user-langserver-dir)
;;     (make-directory lsp-bridge-user-langserver-dir t))
;;   (with-eval-after-load 'lsp-bridge
;;     (let ((json-config (json-encode
;;                         '(:name "rust-analyzer"
;;                           :languageId "rust"
;;                           :command ["rust-analyzer"]
;;                           :settings (:rust-analyzer
;;                                      (:checkOnSave (:command "clippy")
;;                                       :inlayHints (:lifetimeElisionHints (:enable "skip_trivial")
;;                                                    :chainingHints (:enable t)
;;                                                    :closureReturnTypeHints (:enable t)
;;                                                    :parameterHints (:enable nil)
;;                                                    :reborrowHints (:enable nil))
;;                                       :completion (:autoimport (:enable t)
;;                                                    :fullFunctionSignatures (:enable t)
;;                                                    :limit 100)
;;                                       :imports (:granularity (:group "module")
;;                                                 :prefix "self")))
;;                           :port 0)))
;;           (json-file (expand-file-name "rust-analyzer.json" lsp-bridge-user-langserver-dir)))
;;       (with-temp-buffer
;;         (insert json-config)
;;         (write-region (point-min) (point-max) json-file))))
;;   ;; General lsp-bridge settings
;;   (setq lsp-bridge-enable-log nil)
;;   (setq lsp-bridge-enable-auto-import t)
;;   (setq lsp-bridge-enable-inlay-hint t)
;;   (setq lsp-bridge-enable-diagnostics t)
;;   (setq lsp-bridge-enable-signature-help t)
;;   (setq lsp-bridge-diagnostic-fetch-idle 0.6)
;;   (setq lsp-bridge-code-action-enable-popup-menu t)
;;   (setq lsp-bridge-enable-completion nil) ; Disable acm
;;   (setq acm-enable-capf t) ; Enable capf for corfu
;;   (setq lsp-bridge-completion-timeout 0.5)
;;   (setq lsp-bridge-python-command "python3")
;;   (global-lsp-bridge-mode))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Corfu: Lightweight completion UI

;; (use-package corfu
;;   :ensure t
;;   :straight '(corfu :type git :host github :repo "minad/corfu")
;;   :custom
;;   (corfu-auto t)
;;   (corfu-auto-delay 0.1)
;;   (corfu-auto-prefix 0)
;;   (corfu-cycle t)
;;   (corfu-quit-no-match t)
;;   (corfu-sort-function #'corfu-sort-length)
;;   :bind (:map corfu-map
;;               ("C-j" . corfu-next)
;;               ("C-k" . corfu-previous)
;;               ("TAB" . corfu-insert)
;;               ("RET" . corfu-insert))
;;   :init
;;   (global-corfu-mode 1))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Cape: Combine completion sources

;; (use-package cape
;;   :ensure t
;;   :straight '(cape :type git :host github :repo "minad/cape")
;;   :hook (rustic-mode . rk/setup-cape)
;;   :config
;;   (defun rk/setup-cape ()
;;     "Setup cape-super-capf for rustic-mode."
;;     (when (fboundp 'cape-super-capf)
;;       (setq-local completion-at-point-functions
;;                   (list (cape-super-capf #'lsp-bridge-capf #'cape-yasnippet #'cape-dabbrev))))
;;     (unless (fboundp 'cape-super-capf)
;;       (message "Warning: cape-super-capf not available. Update cape package."))))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Kind-icon: Icons for corfu completion

;; (use-package kind-icon
;;   :ensure t
;;   :after corfu
;;   :config
;;   (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Flycheck: Inline error reporting

;; (use-package flycheck
;;   :ensure t
;;   :hook (rustic-mode . flycheck-mode))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; YASnippet: Snippets for code templates

;; (use-package yasnippet
;;   :ensure t
;;   :config
;;   (yas-reload-all)
;;   :hook ((prog-mode . yas-minor-mode)
;;          (text-mode . yas-minor-mode)))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Markdown-mode: Required by lsp-bridge

;; (use-package markdown-mode
;;   :ensure t)

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; DAP-Mode: Debugging support with LLDB

;; (use-package exec-path-from-shell
;;   :ensure t
;;   :init (exec-path-from-shell-initialize))

;; (when (executable-find "lldb-mi")
;;   (use-package dap-mode
;;     :ensure t
;;     :config
;;     (dap-ui-mode 1)
;;     (dap-ui-controls-mode 1)
;;     (require 'dap-lldb)
;;     (require 'dap-gdb-lldb)
;;     (dap-gdb-lldb-setup)
;;     (dap-register-debug-template
;;      "Rust::LLDB Run Configuration"
;;      (list :type "lldb"
;;            :request "launch"
;;            :name "LLDB::Run"
;;            :gdbpath "rust-lldb"))))

;; ;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; ;; Additional settings

;; (setq lsp-bridge-enable-with-tramp nil)



;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; rustic = basic rust-mode + additions

(use-package rustic
  :ensure t
  :bind (:map rustic-mode-map
              ("M-j" . lsp-ui-imenu)
              ("M-?" . lsp-find-references)
              ("C-c C-c l" . flycheck-list-errors)
              ("C-c C-c a" . lsp-execute-code-action)
              ("C-c C-c r" . lsp-rename)
              ("C-c C-c q" . lsp-workspace-restart)
              ("C-c C-c Q" . lsp-workspace-shutdown)
              ("C-c C-c s" . lsp-rust-analyzer-status)
              ("C-c C-c e" . lsp-rust-analyzer-expand-macro)
              ("C-c C-c d" . dap-hydra)
              ("C-c C-c h" . lsp-ui-doc-glance))
  :config
  ;; uncomment for less flashiness
  ;; (setq lsp-eldoc-hook nil)
  ;; (setq lsp-enable-symbol-highlighting nil)
  ;; (setq lsp-signature-auto-activate nil)

  ;; comment to disable rustfmt on save
  (add-hook 'rustic-mode-hook 'rk/rustic-mode-hook))

(defun rk/rustic-mode-hook ()
  ;; so that run C-c C-c C-r works without having to confirm, but don't try to
  ;; save rust buffers that are not file visiting. Once
  ;; https://github.com/brotzeit/rustic/issues/253 has been resolved this should
  ;; no longer be necessary.
  (when buffer-file-name
    (setq-local buffer-save-without-query t))
  (add-hook 'before-save-hook 'lsp-format-buffer nil t))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; for rust-analyzer integration

(use-package lsp-mode
  :ensure t
  :commands lsp
  :custom
  ;; what to use when checking on-save. "check" is default, I prefer clippy
  ;; (lsp-rust-analyzer-cargo-watch-command "clippy")
  (lsp-file-watch-threshold 3500)
  (lsp-headerline-breadcrumb-enable-symbol-numbers nil)
  (lsp-eldoc-render-all t)
  (lsp-idle-delay 0.1)
  ;; This controls the overlays that display type and other hints inline. Enable
  ;; / disable as you prefer. Well require a `lsp-workspace-restart' to have an
  ;; effect on open projects.
  (lsp-rust-analyzer-server-display-inlay-hints t)
  (lsp-rust-analyzer-display-lifetime-elision-hints-enable "skip_trivial")
  (lsp-rust-analyzer-display-chaining-hints t)
  (lsp-rust-analyzer-display-lifetime-elision-hints-use-parameter-names nil)
  ;; (lsp-rust-analyzer-display-closure-return-type-hints t)
  (lsp-rust-analyzer-display-parameter-hints nil)
  (lsp-rust-analyzer-display-reborrow-hints nil)
  :config
  (add-hook 'lsp-mode-hook 'lsp-ui-mode))

(use-package lsp-ui
  :ensure t
  :commands lsp-ui-mode
  :custom
  (lsp-ui-peek-always-show t)
  (lsp-ui-sideline-show-hover t)
  (lsp-ui-doc-enable t))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; lsp-booster

(defun lsp-booster--advice-json-parse (old-fn &rest args)
  "Try to parse bytecode instead of json."
  (or
   (when (equal (following-char) ?#)
     (let ((bytecode (read (current-buffer))))
       (when (byte-code-function-p bytecode)
         (funcall bytecode))))
   (apply old-fn args)))
(advice-add (if (progn (require 'json)
                       (fboundp 'json-parse-buffer))
                'json-parse-buffer
              'json-read)
            :around
            #'lsp-booster--advice-json-parse)

(defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
  "Prepend emacs-lsp-booster command to lsp CMD."
  (let ((orig-result (funcall old-fn cmd test?)))
    (if (and (not test?)                             ;; for check lsp-server-present?
             (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
             lsp-use-plists
             (not (functionp 'json-rpc-connection))  ;; native json-rpc
             (executable-find "emacs-lsp-booster"))
        (progn
          (when-let ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
            (setcar orig-result command-from-exec-path))
          (message "Using emacs-lsp-booster for %s!" orig-result)
          (cons "emacs-lsp-booster" orig-result))
      orig-result)))
(advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; inline errors

(use-package flycheck :ensure t)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; auto-completion and code snippets

(use-package yasnippet
  :ensure t
  :config
  (yas-reload-all)
  (add-hook 'prog-mode-hook 'yas-minor-mode)
  (add-hook 'text-mode-hook 'yas-minor-mode))

;; (use-package elsa
;;   :ensure t)

;; (use-package flycheck-elsa
;;   :ensure t)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; typescript

(use-package typescript-mode
  :ensure t
  :mode (("\\.ts\\'" . typescript-mode)
         ("\\.tsx\\'" . typescript-mode))
  :config
  (define-derived-mode typescriptreact-mode typescript-mode
    "TypeScript TSX"))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; docker and docker-compose

(use-package dockerfile-mode
  :ensure t)

(use-package docker-compose-mode
  :ensure t)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; Create / cleanup rust scratch projects quickly

;; (use-package rust-playground :ensure t)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; for Cargo.toml and other config files

;; (use-package toml-mode :ensure t)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; setting up debugging support with dap-mode

(use-package exec-path-from-shell
  :ensure
  :init (exec-path-from-shell-initialize))

(when (executable-find "lldb-mi")
  (use-package dap-mode
    :ensure t
    :config
    (dap-ui-mode)
    (dap-ui-controls-mode 1)

    (require 'dap-lldb)
    (require 'dap-gdb-lldb)
    ;; installs .extension/vscode
    (dap-gdb-lldb-setup)
    (dap-register-debug-template
     "Rust::LLDB Run Configuration"
     (list :type "lldb"
           :request "launch"
           :name "LLDB::Run"
           :gdbpath "rust-lldb"
           ;; uncomment if lldb-mi is not in PATH
           ;; :lldbmipath "path/to/lldb-mi"
           ))))

(provide 'init-rust)
;;; init-rust.el ends here















;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; rustic = basic rust-mode + additions

(use-package rustic
  :ensure t
  :bind (:map rustic-mode-map
              ("C-c C-c l" . flycheck-list-errors)
              ("C-c C-c a" . eglot-code-actions)
              ("C-c C-c r" . eglot-rename)
              ("C-c C-c q" . eglot-reconnect)
              ("C-c C-c Q" . eglot-shutdown)
              ("C-c C-c s" . eglot-show-workspace-configuration)
              ("C-c C-c e" . eglot-rust-analyzer-expand-macro)
              ("C-c C-c d" . dap-hydra)
              ("C-c C-c h" . eglot-inlay-hints-mode))
  :config
  ;; Отключение избыточных функций (аналог lsp-eldoc-hook и прочих)
  (setq eldoc-idle-delay 0.1)
  ;; Настройка форматирования при сохранении
  (add-hook 'rustic-mode-hook 'rk/rustic-mode-hook))

(defun rk/rustic-mode-hook ()
  ;; Автосохранение без запроса для файловых буферов
  (when buffer-file-name
    (setq-local buffer-save-without-query t))
  (add-hook 'before-save-hook 'eglot-format-buffer nil t))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; eglot для интеграции с rust-analyzer

(use-package eglot
  :ensure t
  :hook (rustic-mode . eglot-ensure)
  :custom
  ;; Настройка rust-analyzer
  (eglot-autoshutdown t) ;; Автоматически завершать сервер
  (eglot-confirm-server-initiated-edits nil) ;; Не запрашивать подтверждение изменений от сервера
  (eglot-extend-to-xref t) ;; Поддержка перехода к определениям
  :config
  ;; Настройка rust-analyzer как сервера для Rust
  (add-to-list 'eglot-server-programs
               '(rustic-mode . ("rust-analyzer" :initializationOptions
                                (:cargo (:watchCommand "clippy")
                                 :procMacro (:enable t)
                                 :inlayHints (:typeHints t
                                              :chainingHints t
                                              :parameterHints nil
                                              :lifetimeElisionHints (:enable "skip_trivial"))))))
  ;; Включение inlay hints (аналог lsp-rust-analyzer-server-display-inlay-hints)
  (add-hook 'eglot-managed-mode-hook #'eglot-inlay-hints-mode))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; eglot-booster для ускорения

;; (use-package eglot-booster
;;   :ensure t
;;   :after eglot
;;   :config
;;   (eglot-booster-mode))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; inline errors

(use-package flycheck
  :ensure t
  :hook (rustic-mode . flycheck-mode))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; auto-completion и code snippets

(use-package yasnippet
  :ensure t
  :config
  (yas-reload-all)
  (add-hook 'prog-mode-hook 'yas-minor-mode)
  (add-hook 'text-mode-hook 'yas-minor-mode))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; typescript

(use-package typescript-mode
  :ensure t
  :mode (("\\.ts\\'" . typescript-mode)
         ("\\.tsx\\'" . typescript-mode))
  :config
  (define-derived-mode typescriptreact-mode typescript-mode
    "TypeScript TSX")
  :hook (typescript-mode . eglot-ensure))

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; docker и docker-compose

(use-package dockerfile-mode
  :ensure t)

(use-package docker-compose-mode
  :ensure t)

;; -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
;; настройка отладки с dap-mode

(use-package exec-path-from-shell
  :ensure t
  :init (exec-path-from-shell-initialize))

(when (executable-find "lldb-mi")
  (use-package dap-mode
    :ensure t
    :config
    (dap-ui-mode)
    (dap-ui-controls-mode 1)
    (require 'dap-lldb)
    (require 'dap-gdb-lldb)
    (dap-gdb-lldb-setup)
    (dap-register-debug-template
     "Rust::LLDB Run Configuration"
     (list :type "lldb"
           :request "launch"
           :name "LLDB::Run"
           :gdbpath "rust-lldb"))))

(provide 'init-rust)
;;; init-rust.el ends here







(use-package lsp-mode
  :diminish "LSP"
  :ensure t
  :hook ((lsp-mode . lsp-diagnostics-mode)
         (lsp-mode . lsp-enable-which-key-integration)
         ((tsx-ts-mode
           typescript-ts-mode
           js-ts-mode) . lsp-deferred))
  :custom
  (lsp-keymap-prefix "C-c l")           ; Prefix for LSP actions
  (lsp-completion-provider :none)       ; Using Corfu as the provider
  (lsp-diagnostics-provider :flycheck)
  (lsp-session-file (locate-user-emacs-file ".lsp-session"))
  (lsp-log-io nil)                      ; IMPORTANT! Use only for debugging! Drastically affects performance
  (lsp-keep-workspace-alive nil)        ; Close LSP server if all project buffers are closed
  (lsp-idle-delay 0.5)                  ; Debounce timer for `after-change-function'
  ;; core
  (lsp-enable-xref t)                   ; Use xref to find references
  (lsp-auto-configure t)                ; Used to decide between current active servers
  (lsp-eldoc-enable-hover t)            ; Display signature information in the echo area
  (lsp-enable-dap-auto-configure t)     ; Debug support
  (lsp-enable-file-watchers nil)
  (lsp-enable-folding nil)              ; I disable folding since I use origami
  (lsp-enable-imenu t)
  (lsp-enable-indentation nil)          ; I use prettier
  (lsp-enable-links nil)                ; No need since we have `browse-url'
  (lsp-enable-on-type-formatting nil)   ; Prettier handles this
  (lsp-enable-suggest-server-download t) ; Useful prompt to download LSP providers
  (lsp-enable-symbol-highlighting t)     ; Shows usages of symbol at point in the current buffer
  (lsp-enable-text-document-color nil)   ; This is Treesitter's job

  (lsp-ui-sideline-show-hover nil)      ; Sideline used only for diagnostics
  (lsp-ui-sideline-diagnostic-max-lines 20) ; 20 lines since typescript errors can be quite big
  ;; completion
  (lsp-completion-enable t)
  (lsp-completion-enable-additional-text-edit t) ; Ex: auto-insert an import for a completion candidate
  (lsp-enable-snippet t)                         ; Important to provide full JSX completion
  (lsp-completion-show-kind t)                   ; Optional
  ;; headerline
  (lsp-headerline-breadcrumb-enable t)  ; Optional, I like the breadcrumbs
  (lsp-headerline-breadcrumb-enable-diagnostics nil) ; Don't make them red, too noisy
  (lsp-headerline-breadcrumb-enable-symbol-numbers nil)
  (lsp-headerline-breadcrumb-icons-enable nil)
  ;; modeline
  (lsp-modeline-code-actions-enable nil) ; Modeline should be relatively clean
  (lsp-modeline-diagnostics-enable nil)  ; Already supported through `flycheck'
  (lsp-modeline-workspace-status-enable nil) ; Modeline displays "LSP" when lsp-mode is enabled
  (lsp-signature-doc-lines 1)                ; Don't raise the echo area. It's distracting
  (lsp-ui-doc-use-childframe t)              ; Show docs for symbol at point
  (lsp-eldoc-render-all nil)            ; This would be very useful if it would respect `lsp-signature-doc-lines', currently it's distracting
  ;; lens
  (lsp-lens-enable nil)                 ; Optional, I don't need it
  ;; semantic
  (lsp-semantic-tokens-enable nil)      ; Related to highlighting, and we defer to treesitter
  :config
  (setq lsp-rust-server 'rust-analyzer)
  (setq lsp-rust-analyzer-server-command '("/home/berezhnev/.cargo/bin/rust-analyzer"))

  :init
  (setq lsp-use-plists t)
  :preface
  (defun lsp-booster--advice-json-parse (old-fn &rest args)
    "Try to parse bytecode instead of json."
    (or
     (when (equal (following-char) ?#)
       
       (let ((bytecode (read (current-buffer))))
         (when (byte-code-function-p bytecode)
           (funcall bytecode))))
     (apply old-fn args)))
  (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
    "Prepend emacs-lsp-booster command to lsp CMD."
    (let ((orig-result (funcall old-fn cmd test?)))
      (if (and (not test?)                             ;; for check lsp-server-present?
               (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
               lsp-use-plists
               (not (functionp 'json-rpc-connection))  ;; native json-rpc
               (executable-find "emacs-lsp-booster"))
          (progn
            (message "Using emacs-lsp-booster for %s!" orig-result)
            (cons "emacs-lsp-booster" orig-result))
        orig-result)))
  :init
  (setq lsp-use-plists t)
  ;; Initiate https://github.com/blahgeek/emacs-lsp-booster for performance
  (advice-add (if (progn (require 'json)
                         (fboundp 'json-parse-buffer))
                  'json-parse-buffer
                'json-read)
              :around
              #'lsp-booster--advice-json-parse)
  (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command))

    (use-package lsp-completion
      :no-require
      :hook ((lsp-mode . lsp-completion-mode)))

    (use-package lsp-ui
      :ensure t
      :commands
      (lsp-ui-doc-show
       lsp-ui-doc-glance)
      :bind (:map lsp-mode-map
                  ("C-c C-d" . 'lsp-ui-doc-glance))
      :after (lsp-mode evil)
      :config (setq lsp-ui-doc-enable t
                    evil-lookup-func #'lsp-ui-doc-glance ; Makes K in evil-mode toggle the doc for symbol at point
                    lsp-ui-doc-show-with-cursor nil      ; Don't show doc when cursor is over symbol - too distracting
                    lsp-ui-doc-include-signature t       ; Show signature
                    lsp-ui-doc-position 'at-point))






;; (use-package lsp-bridge
;;   :straight '(lsp-bridge :type git :host github :repo "manateelazycat/lsp-bridge"
;;                          :files (:defaults "*.el" "*.py" "acm" "core" "langserver" "multiserver" "resources")
;;                          :build (:not compile))
;;   ;; :init
;;   ;; (global-lsp-bridge-mode)
;;   ;; (defun lsp-bridge-hook ()
;;   ;;   ;; Отключить company-mode и corfu в lsp-bridge
;;   ;;   (when (featurep 'corfu)
;;   ;;     (corfu-mode -1))
;;   ;;   (when (featurep 'company)
;;   ;;     (company-mode -1)))
;;   :hook
;;   ((emacs-lisp-mode    . lsp-bridge-mode)
;;    (rustic-mode        . lsp-bridge-mode)
;;    (typescript-mode    . lsp-bridge-mode)
;;    (typescript-ts-mode . lsp-bridge-mode)
;;    (dockerfile-mode    . lsp-bridge-mode))
;;   :bind (:map lsp-bridge-mode-map
;;               ("C-." . lsp-bridge-show-documentation)
;;               ("M-n" . lsp-bridge-diagnostic-jump-next)
;;               ("M-p" . lsp-bridge-diagnostic-jump-prev)
;;               ("M-." . lsp-bridge-find-def)
;;               ("M-," . lsp-bridge-find-def-return))
;;   :config
;;   (setq lsp-bridge-enable-hover-diagnostic t
;; 	lsp-bridge-headerline-breadcrumb-enable nil
;; 	lsp-headerline-breadcrumb-enable nil
;; 	lsp-file-watch-threshold 3500 ;; Default: 1000
;;         acm-enable-capf t ;; Enable CAPF for non-LSP backends (e.g., Emacs Lisp)
;;         ;; lsp-bridge-enable-org-babel t
;; 	;; lsp-bridge-enable-with-tramp t
;; 	acm-enable-doc t
;;         lsp-bridge-enable-inlay-hint t
;;         ;; acm-enable-elisp t ;; Explicitly enable Emacs Lisp completion backend
;;         ;; acm-backend-elisp-candidate-min-length 0 ;; Trigger completion immediately
;;         lsp-bridge-headerline-breadcrumb-enable t) ;; Disable breadcrumbs
;;   ;; Ensure acm is initialized for elisp
;;   ;; (add-to-list 'acm-backend-capf-mode-list 'emacs-lisp-mode)
;;   )

;; init-rust.el --- Configuration for Rust and related development tools

;; LSP-mode: Load for programming modes
;; (use-package lsp-mode
;;   :straight t
;;   ;; :commands (lsp lsp-deferred)
;;   :hook ((tsx-mode        . lsp-deferred)
;;          (typescript-mode . lsp-deferred)
;;          (js-mode         . lsp-deferred)
;;          (rustic-mode     . lsp-deferred)
;; 	 (emacs-lisp-mode . lsp-deferred)
;;          ;; (lsp-mode . lsp-diagnostics-mode)
;;          ;; (lsp-mode . lsp-enable-which-key-integration)
;; 	 )
;;   :init
;;   (setq lsp-file-watch-threshold 3500
;;         lsp-headerline-breadcrumb-enable-symbol-numbers nil
;;         lsp-eldoc-render-all t
;;         lsp-idle-delay 0.1
;;         lsp-rust-analyzer-server-display-inlay-hints t
;;         lsp-rust-analyzer-display-chaining-hints t)
;;   :config
;;   (add-hook 'lsp-mode-hook 'lsp-ui-mode))

;; LSP-ui: Load after lsp-mode
;; (use-package lsp-ui
;;   :straight t
;;   ;; :after lsp-mode
;;   ;; :commands (lsp-ui-mode)
;;   :custom
;;   (lsp-ui-peek-always-show t)
;;   (lsp-ui-sideline-show-hover t)
;;   (lsp-ui-doc-enable t))

;; ;; LSP-booster: Configure advice without loading packages
;; (defun lsp-booster--advice-json-parse (old-fn &rest args)
;;   "Try to parse bytecode instead of json."
;;   (or
;;    (when (equal (following-char) ?#)
;;      (let ((bytecode (read (current-buffer))))
;;        (when (byte-code-function-p bytecode)
;;          (funcall bytecode))))
;;    (apply old-fn args)))

;; (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
;;   "Prepend emacs-lsp-booster command to lsp CMD."
;;   (let ((orig-result (funcall old-fn cmd test?)))
;;     (if (and (not test?)
;;              (not (file-remote-p default-directory))
;;              lsp-use-plists
;;              (not (functionp 'json-rpc-connection))
;;              (executable-find "emacs-lsp-booster"))
;;         (progn
;;           (when-let ((command-from-exec-path (executable-find (car orig-result))))
;;             (setcar orig-result command-from-exec-path))
;;           (message "Using emacs-lsp-booster for %s!" orig-result)
;;           (cons "emacs-lsp-booster" orig-result))
;;       orig-result)))

;; (with-eval-after-load 'lsp-mode
;;   (advice-add (if (and (require 'json nil t)
;;                        (fboundp 'json-parse-buffer))
;;                   'json-parse-buffer
;;                 'json-read)
;;               :around #'lsp-booster--advice-json-parse)
;;   (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command))

;; (use-package lsp-mode
;;   :straight t)

